<!-- _includes/lzgen.html -->
<section id="lzgen" class="lz-wrap">
  <h2>CAF Ready - Landing Zone Generator</h2>
  <p>Pick a preset or configure everything. Click Generate to get Bicep and Terraform starters. You can also export ALZ-compatible params and tfvars.</p>

  <div class="lz-grid">
    <div class="lz-card">
      <h3>Preset</h3>
      <select id="preset">
        <option value="starter">Starter - SMB, quick start</option>
        <option value="regulated">Regulated - strong policy set</option>
        <option value="enterprise">Enterprise - multi subscription, hub and spoke</option>
      </select>
      <button type="button" id="applyPreset">Apply preset</button>
    </div>

    <div class="lz-card">
      <h3>Organization</h3>
      <label>Org size*
        <select id="orgSize" required>
          <option value="">Please choose</option>
          <option>Solo IT</option>
          <option>Team</option>
          <option>Enterprise</option>
        </select>
      </label>
      <label>Subscription model*
        <select id="subModel" required>
          <option value="">Please choose</option>
          <option>Single</option>
          <option>Multi</option>
        </select>
      </label>
      <label>Regions strategy
        <select id="regionPlan">
          <option>Primary</option>
          <option>Primary+DR</option>
          <option>Multi region</option>
        </select>
      </label>
    </div>

    <div class="lz-card">
      <h3>Identity</h3>
      <label>Entra license
        <select id="entraLevel">
          <option>P1</option>
          <option>P2</option>
        </select>
      </label>
      <label>Identity source
        <select id="identitySource">
          <option>Cloud only</option>
          <option>Hybrid (AD Connect)</option>
        </select>
      </label>
      <label>RBAC baseline
        <select id="rbac">
          <option>Least privilege</option>
          <option>Owner restricted</option>
          <option>Relaxed</option>
        </select>
      </label>
    </div>

    <div class="lz-card">
      <h3>Network</h3>
      <label>Topology*
        <select id="topology" required>
          <option value="">Please choose</option>
          <option>Flat</option>
          <option>Hub-and-Spoke</option>
          <option>Mesh</option>
        </select>
      </label>
      <label>Connectivity*
        <select id="connectivity" required>
          <option value="">Please choose</option>
          <option>None</option>
          <option>Site-to-Site VPN</option>
          <option>ExpressRoute</option>
        </select>
      </label>
      <label>Private DNS
        <select id="privDns">
          <option>Yes</option>
          <option>No</option>
        </select>
      </label>
    </div>

    <div class="lz-card">
      <h3>Governance and Policy</h3>
      <label>Policy level*
        <select id="policyLevel" required>
          <option value="">Please choose</option>
          <option>Basic</option>
          <option>Standard</option>
          <option>Strict</option>
        </select>
      </label>
      <label>Allowed regions
        <input id="allowedRegions" type="text" placeholder="e.g. westeurope, northeurope">
      </label>
      <label>Tags (comma separated)
        <input id="tagSchema" type="text" value="CostCenter,Owner,Environment">
      </label>
      <label>Subscription vending
        <select id="vending">
          <option>Manual</option>
          <option>Automated</option>
        </select>
      </label>
      <label>Compliance pack
        <select id="compliance">
          <option value="None" selected>None</option>
          <option value="MCSB">Microsoft Cloud Security Benchmark</option>
          <option value="ISO27001">ISO 27001</option>
          <option value="NIST80053">NIST SP 800-53</option>
          <option value="CIS">CIS Foundations</option>
          <option value="PCI">PCI DSS</option>
        </select>
      </label>
    </div>

    <div class="lz-card">
      <h3>Security</h3>
      <label>Defender for Cloud*
        <select id="defender" required>
          <option value="">Please choose</option>
          <option>Off</option>
          <option>Essentials</option>
          <option>Full</option>
        </select>
      </label>
      <label>Key management
        <select id="keys">
          <option>Platform managed</option>
          <option>Customer managed</option>
        </select>
      </label>
      <label>Baseline controls
        <select id="baseline">
          <option>Standard</option>
          <option>High</option>
        </select>
      </label>
    </div>

    <div class="lz-card">
      <h3>Ops and Cost</h3>
      <label>Monitoring
        <select id="monitoring">
          <option>Log Analytics</option>
          <option>Log Analytics + SIEM</option>
        </select>
      </label>
      <label>Backup and DR
        <select id="bcdr">
          <option>Azure Backup</option>
          <option>Azure Backup + ASR</option>
          <option>3rd party</option>
        </select>
      </label>
      <label>Monthly budget per subscription (€)*
        <input id="budget" type="number" min="0" step="50" placeholder="e.g. 1000" required>
      </label>
      <label>Alerts
        <input id="alerts" type="text" value="50,80,100">
      </label>
    </div>

    <div class="lz-card">
      <h3>Automation</h3>
      <label>IaC*
        <select id="iac" required>
          <option value="">Please choose</option>
          <option>Bicep</option>
          <option>Terraform</option>
        </select>
      </label>
      <label>Pipelines
        <select id="pipelines">
          <option>GitHub Actions</option>
          <option>Azure DevOps</option>
          <option>None</option>
        </select>
      </label>
      <label>Archetype
        <select id="archetype">
          <option>Foundation</option>
          <option>AKS</option>
          <option>AVD</option>
          <option>SAP</option>
          <option>APIM</option>
        </select>
      </label>
    </div>
  </div>

  <div class="lz-actions">
    <button type="button" id="generate">Generate</button>
    <button type="button" id="copyBicep">Copy Bicep</button>
    <button type="button" id="copyTf">Copy Terraform</button>
    <button type="button" id="downloadBicep">Download Bicep</button>
    <button type="button" id="downloadTf">Download Terraform</button>
    <button type="button" id="exportAlz">Export ALZ params.json</button>
    <button type="button" id="exportTfvars">Export tfvars</button>
    <button type="button" id="share">Share link</button>
    <span id="toast" role="status" aria-live="polite"></span>
  </div>

  <details open class="lz-output">
    <summary>Output</summary>
    <h4>Summary</h4>
    <pre id="summary"></pre>
    <h4>Bicep</h4>
    <pre id="bicep"></pre>
    <h4>Terraform</h4>
    <pre id="tf"></pre>
  </details>
</section>

<style>
.lz-wrap{font:16px/1.5 system-ui,Segoe UI,Roboto,Arial,sans-serif;max-width:1100px;margin:2rem auto;padding:1rem}
.lz-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem}
.lz-card{border:1px solid var(--b,#ddd);border-radius:10px;padding:1rem;background:var(--bg,#fff);box-shadow:0 1px 2px rgba(0,0,0,.04)}
.lz-card h3{margin:.2rem 0 .6rem 0;font-size:1.05rem}
label{display:block;margin:.5rem 0}
input,select,button{width:100%;padding:.6rem;border:1px solid var(--b,#ccc);border-radius:8px;background:var(--bg,#fff)}
button{cursor:pointer}
.lz-actions{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:.6rem;margin:1rem 0}
.lz-output pre{white-space:pre-wrap;background:#0a0a0a;color:#f4f4f4;padding:1rem;border-radius:10px;overflow:auto}
#toast{display:inline-block;margin-left:.5rem;min-height:1.2em}
@media (prefers-color-scheme: dark){
  :root{--bg:#111;--b:#333}
  body{background:#000;color:#eee}
  .lz-card{background:#111;border-color:#333}
  input,select,button{background:#0d0d0d;color:#eee;border-color:#333}
}
</style>

<script>
(function(){
  const ids = ["preset","orgSize","subModel","regionPlan","entraLevel","identitySource","rbac","topology","connectivity","privDns","policyLevel","allowedRegions","tagSchema","vending","compliance","defender","keys","baseline","monitoring","bcdr","budget","alerts","iac","pipelines","archetype"];
  const el = Object.fromEntries(ids.map(id=>[id,document.getElementById(id)]));
  const out = {summary:document.getElementById("summary"), bicep:document.getElementById("bicep"), tf:document.getElementById("tf"), toast:document.getElementById("toast")};
  const btn = {
    applyPreset:document.getElementById("applyPreset"),
    generate:document.getElementById("generate"),
    copyBicep:document.getElementById("copyBicep"),
    copyTf:document.getElementById("copyTf"),
    downloadBicep:document.getElementById("downloadBicep"),
    downloadTf:document.getElementById("downloadTf"),
    exportAlz:document.getElementById("exportAlz"),
    exportTfvars:document.getElementById("exportTfvars"),
    share:document.getElementById("share")
  };

  const presets = {
    starter:{
      orgSize:"Team", subModel:"Single", regionPlan:"Primary+DR",
      entraLevel:"P1", identitySource:"Cloud only", rbac:"Least privilege",
      topology:"Flat", connectivity:"None", privDns:"Yes",
      policyLevel:"Standard", allowedRegions:"westeurope,northeurope", tagSchema:"CostCenter,Owner,Environment", vending:"Manual", compliance:"None",
      defender:"Essentials", keys:"Platform managed", baseline:"Standard",
      monitoring:"Log Analytics", bcdr:"Azure Backup",
      budget:"1000", alerts:"50,80,100",
      iac:"Bicep", pipelines:"GitHub Actions", archetype:"Foundation"
    },
    regulated:{
      orgSize:"Enterprise", subModel:"Multi", regionPlan:"Primary+DR",
      entraLevel:"P2", identitySource:"Hybrid (AD Connect)", rbac:"Owner restricted",
      topology:"Hub-and-Spoke", connectivity:"Site-to-Site VPN", privDns:"Yes",
      policyLevel:"Strict", allowedRegions:"westeurope,northeurope", tagSchema:"CostCenter,Owner,Environment,DataClass", vending:"Automated", compliance:"ISO27001",
      defender:"Full", keys:"Customer managed", baseline:"High",
      monitoring:"Log Analytics + SIEM", bcdr:"Azure Backup + ASR",
      budget:"5000", alerts:"50,75,90,100",
      iac:"Bicep", pipelines:"Azure DevOps", archetype:"APIM"
    },
    enterprise:{
      orgSize:"Enterprise", subModel:"Multi", regionPlan:"Multi region",
      entraLevel:"P2", identitySource:"Hybrid (AD Connect)", rbac:"Least privilege",
      topology:"Hub-and-Spoke", connectivity:"ExpressRoute", privDns:"Yes",
      policyLevel:"Standard", allowedRegions:"westeurope,northeurope", tagSchema:"CostCenter,Owner,Environment,BusinessUnit", vending:"Automated", compliance:"MCSB",
      defender:"Full", keys:"Platform managed", baseline:"High",
      monitoring:"Log Analytics + SIEM", bcdr:"Azure Backup + ASR",
      budget:"8000", alerts:"50,80,100",
      iac:"Terraform", pipelines:"Azure DevOps", archetype:"AKS"
    }
  };

  function applyPreset(name){
    const p = presets[name];
    Object.entries(p).forEach(([k,v]) => { if (el[k]) el[k].value = String(v); });
    saveState(); toast("Preset applied");
  }

  function validate(){
    const required = ["orgSize","subModel","topology","connectivity","policyLevel","defender","budget","iac"];
    const missing = required.filter(k=>!el[k].value);
    if(missing.length){ toast("Please fill required fields: " + missing.join(", ")); return false; }
    return true;
  }

  function buildSummary(state){
    const lines = [];
    lines.push(`Model: ${state.subModel}, Topology: ${state.topology}, Regions: ${state.regionPlan}`);
    lines.push(`Identity: ${state.identitySource} (${state.entraLevel}), RBAC: ${state.rbac}`);
    lines.push(`Connectivity: ${state.connectivity}, Private DNS: ${state.privDns}`);
    lines.push(`Policy level: ${state.policyLevel}, Allowed regions: ${state.allowedRegions||"not restricted"}`);
    lines.push(`Tags: ${state.tagSchema}, Compliance: ${state.compliance}`);
    lines.push(`Security: Defender=${state.defender}, Baseline=${state.baseline}, Keys=${state.keys}`);
    lines.push(`Ops: Monitoring=${state.monitoring}, BCDR=${state.bcdr}`);
    lines.push(`Cost: Budget=${state.budget}€, Alerts=${state.alerts}`);
    lines.push(`Automation: IaC=${state.iac}, Pipeline=${state.pipelines}, Archetype=${state.archetype}`);
    if(state.subModel==="Multi"){
      lines.push(`MG suggestion: Tenant Root -> Platform, LandingZones, Sandbox`);
      lines.push(`Suggested subscriptions: Connectivity, Identity, Management, Workload spokes`);
    } else {
      lines.push(`Suggestion: Single subscription with clear RG split for platform and workloads`);
    }
    return lines.join("\n");
  }

  function bicepTemplate(s){
    const allowRegions = (s.allowedRegions||"").split(",").map(x=>x.trim()).filter(Boolean);
    const tags = (s.tagSchema||"").split(",").map(x=>x.trim()).filter(Boolean);

    return `// CAF Ready Bicep Starter
targetScope = 'subscription'

@description('Default location for platform resources')
param location string = 'westeurope'

@description('Monthly budget in EUR')
param monthlyBudget int = ${Number(s.budget)||1000}

@description('Alert thresholds in percent')
param thresholds array = [${(s.alerts||"50,80,100").split(",").map(x=>x.trim()).filter(Boolean).map(n=>Number(n)).join(", ")}]

// Resource Group example
resource rg_mgmt 'Microsoft.Resources/resourceGroups@2024-03-01' = {
  name: 'rg-mgmt'
  location: location
  tags: {
    ${tags.map(t=>`${t}: '${t.toLowerCase() === "environment" ? "prod" : t.toLowerCase() === "owner" ? "it" : t.toLowerCase() === "costcenter" ? "1000" : "set"}'`).join(",\n    ")}
  }
}

// Budget
resource budget 'Microsoft.Consumption/budgets@2023-05-01' = {
  name: 'lz-monthly-budget'
  scope: subscription().id
  properties: {
    category: 'Cost'
    amount: monthlyBudget
    timeGrain: 'Monthly'
    timePeriod: {
      startDate: dateTimeAdd(utcNow(), '-P1D')
      endDate: dateTimeAdd(utcNow(), 'P1Y')
    }
    notifications: {
      ${ (s.alerts||"50,80,100").split(",").map((a,i)=>`n${i}: { enabled: true, threshold: ${Number(a)}, operator: 'EqualTo', contactEmails: [ 'alerts@example.com' ] }`).join(",\n      ") }
    }
  }
}

// Hub VNet optional by topology
${s.topology === "Hub-and-Spoke" ? `
resource rg_network 'Microsoft.Resources/resourceGroups@2024-03-01' = {
  name: 'rg-network-hub'
  location: location
}

resource vnet_hub 'Microsoft.Network/virtualNetworks@2023-11-01' = {
  name: 'vnet-hub'
  location: location
  tags: rg_mgmt.tags
  properties: {
    addressSpace: { addressPrefixes: [ '10.0.0.0/16' ] }
    subnets: [
      { name: 'AzureFirewallSubnet', properties: { addressPrefix: '10.0.1.0/24' } }
      { name: 'mgmt', properties: { addressPrefix: '10.0.2.0/24' } }
    ]
  }
}
` : `// Flat topology - per workload VNet later`
}

// Policy - Allowed Locations
${allowRegions.length ? `
resource policyDef 'Microsoft.Authorization/policyDefinitions@2021-06-01' = {
  name: 'allowed-locations'
  properties: {
    policyType: 'Custom'
    mode: 'All'
    displayName: 'Allowed locations'
    policyRule: {
      if: { field: 'location', notIn: ${JSON.stringify(allowRegions)} }
      then: { effect: 'Deny' }
    }
  }
}
resource policyAssign 'Microsoft.Authorization/policyAssignments@2022-06-01' = {
  name: 'enforce-allowed-locations'
  properties: {
    displayName: 'Enforce allowed locations'
    policyDefinitionId: policyDef.id
  }
}
` : `// No allowed locations policy set`
}

// Security baseline
${s.baseline==="High" ? `// Example: deny public IP without NSG, enforce disk encryption
// In production use a Policy Initiative for a complete set` : `// Standard baseline active`}

// Defender
// ${s.defender} - Plan assignment will be added in production template

// Note: This is a minimal starter, extend as needed
`;
  }

  function tfTemplate(s){
    const allowRegions = (s.allowedRegions||"").split(",").map(x=>x.trim()).filter(Boolean);
    return `# CAF Ready Terraform Starter
terraform {
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 3.112"
    }
  }
}

provider "azurerm" { features {} }

variable "location" { type = string, default = "westeurope" }
variable "monthly_budget" { type = number, default = ${Number(s.budget)||1000} }

resource "azurerm_resource_group" "rg_mgmt" {
  name     = "rg-mgmt"
  location = var.location
  tags = {
    Environment = "prod"
    Owner       = "it"
    CostCenter  = "1000"
  }
}

# Budget note: Azure budget uses Consumption API - placeholder here

# Optional network hub by topology
${s.topology==="Hub-and-Spoke" ? `
resource "azurerm_resource_group" "rg_network_hub" {
  name     = "rg-network-hub"
  location = var.location
}

resource "azurerm_virtual_network" "vnet_hub" {
  name                = "vnet-hub"
  location            = var.location
  resource_group_name = azurerm_resource_group.rg_network_hub.name
  address_space       = ["10.0.0.0/16"]
}
` : `# Flat topology - per workload VNet later`}

# Allowed locations policy would use azurerm_policy_definition and assignment

# Note: Starter, extend for production
`;
  }

  function buildAlzParams(s){
    const allowRegions = (s.allowedRegions||"").split(",").map(x=>x.trim()).filter(Boolean);
    const thresholds = (s.alerts||"50,80,100").split(",").map(x=>Number(x.trim())).filter(n=>!Number.isNaN(n));
    const tags = (s.tagSchema||"").split(",").map(x=>x.trim()).filter(Boolean);

    return {
      // minimal ALZ compatible-ish params to hand over to Enterprise Scale pipelines
      locationDefault: "westeurope",
      managementGroups: {
        root: "Tenant Root",
        platform: "Platform",
        landingZones: "LandingZones",
        sandbox: "Sandbox"
      },
      subscriptionModel: s.subModel,
      network: {
        topology: s.topology,
        connectivity: s.connectivity,
        privateDnsResolver: s.privDns === "Yes"
      },
      governance: {
        policyLevel: s.policyLevel,
        allowedRegions: allowRegions,
        tags: tags,
        vending: s.vending
      },
      security: {
        defenderPlan: s.defender,
        baseline: s.baseline,
        compliancePack: s.compliance,
        keyManagement: s.keys
      },
      cost: {
        monthlyBudget: Number(s.budget)||0,
        thresholds: thresholds
      },
      automation: {
        iac: s.iac,
        pipeline: s.pipelines
      },
      archetype: s.archetype
    };
  }

  function buildTfvars(s){
    const p = buildAlzParams(s);
    // flatten a little for tfvars readability
    return {
      location_default: p.locationDefault,
      mg_root: p.managementGroups.root,
      mg_platform: p.managementGroups.platform,
      mg_landingzones: p.managementGroups.landingZones,
      mg_sandbox: p.managementGroups.sandbox,
      subscription_model: p.subscriptionModel,
      network_topology: p.network.topology,
      network_connectivity: p.network.connectivity,
      private_dns_resolver: p.network.privateDnsResolver,
      policy_level: p.governance.policyLevel,
      allowed_regions: p.governance.allowedRegions,
      tag_schema: p.governance.tags,
      subscription_vending: p.governance.vending,
      defender_plan: p.security.defenderPlan,
      security_baseline: p.security.baseline,
      compliance_pack: p.security.compliancePack,
      key_management: p.security.keyManagement,
      monthly_budget: p.cost.monthlyBudget,
      budget_thresholds: p.cost.thresholds,
      iac_tool: p.automation.iac,
      pipeline_tool: p.automation.pipeline,
      archetype: p.archetype
    };
  }

  function generate(){
    if(!validate()) return;
    const state = readState();
    out.summary.textContent = buildSummary(state);
    out.bicep.textContent = bicepTemplate(state);
    out.tf.textContent    = tfTemplate(state);
    toast("Generated");
  }

  function readState(){
    const state = Object.fromEntries(ids.map(k=>[k, el[k].value.trim ? el[k].value.trim() : el[k].value]));
    return state;
  }
  function writeState(state){
    Object.entries(state).forEach(([k,v])=>{ if(el[k]) el[k].value = v; });
  }
  function saveState(){
    localStorage.setItem("lzgen:v1", JSON.stringify(readState()));
  }
  function loadState(){
    const hash = location.hash.startsWith("#lz=") ? location.hash.slice(4) : null;
    if(hash){
      try{
        const json = decodeURIComponent(atob(hash));
        const state = JSON.parse(json);
        writeState(state); toast("Config loaded from link"); return;
      }catch(e){ /* ignore */ }
    }
    const raw = localStorage.getItem("lzgen:v1");
    if(raw){ try{ writeState(JSON.parse(raw)); }catch(e){} }
  }

  function copy(text){
    navigator.clipboard.writeText(text).then(()=>toast("Copied")).catch(()=>toast("Copy failed"));
  }
  function download(filename, content){
    const blob = new Blob([content], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }
  function shareLink(){
    const state = readState();
    const encoded = btoa(encodeURIComponent(JSON.stringify(state)));
    const url = location.origin + location.pathname + "#lz=" + encoded;
    copy(url); toast("Share link copied");
  }
  function toast(msg){ out.toast.textContent = msg; setTimeout(()=>out.toast.textContent="",3000); }

  btn.applyPreset?.addEventListener("click", ()=>applyPreset(el.preset.value));
  btn.generate.addEventListener("click", generate);
  btn.copyBicep.addEventListener("click", ()=>copy(out.bicep.textContent));
  btn.copyTf.addEventListener("click", ()=>copy(out.tf.textContent));

  btn.downloadBicep.addEventListener("click", ()=>{
    const s = readState();
    const text = bicepTemplate(s);
    const blob = new Blob([text], {type:"text/plain"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "caf-ready-lz.bicep";
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
  });
  btn.downloadTf.addEventListener("click", ()=>{
    const s = readState();
    const text = tfTemplate(s);
    const blob = new Blob([text], {type:"text/plain"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "caf-ready-lz.tf";
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
  });

  btn.exportAlz.addEventListener("click", ()=>{
    const json = JSON.stringify(buildAlzParams(readState()), null, 2);
    download("alz-platform.params.json", json);
    toast("Exported ALZ params.json");
  });
  btn.exportTfvars.addEventListener("click", ()=>{
    const tfvarsObj = buildTfvars(readState());
    const text = Object.entries(tfvarsObj).map(([k,v])=>{
      if(Array.isArray(v)) return `${k} = [${v.map(x=>typeof x==="string" ? `"${x}"` : x).join(", ")}]`;
      if(typeof v === "string") return `${k} = "${v}"`;
      return `${k} = ${v}`;
    }).join("\n");
    const blob = new Blob([text], {type:"text/plain"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "alz-platform.tfvars";
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
    toast("Exported tfvars");
  });

  btn.share.addEventListener("click", shareLink);

  ids.forEach(k=> el[k].addEventListener("change", saveState));

  loadState();
  if(!localStorage.getItem("lzgen:v1")) applyPreset("starter");
})();
</script>
